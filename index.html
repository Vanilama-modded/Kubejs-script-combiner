<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KubeJS Script File Combiner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- No need for KubeJS, just basic JS -->
  <style>
    body {
      font-family: system-ui,sans-serif;
      background: #23272b;
      color: #e9e9e9;
      padding: 40px 0;
    }
    .container {
      background: var(--discord-bg-accent);
      border-radius: 10px;
      margin: 0 auto;
      max-width: 430px;
      padding: 2em 2em 2.5em 2em;
      box-shadow: 0 11px 26px -14px #000a;
    }
    h1 {
      text-align: center;
      font-size: 1.6em;
      font-weight: 700;
    }
    input[type="file"] {
      display: block;
      margin: 1.2em 0;
      color: #23272b;
      background: #fff;
      border-radius: 5px;
      font-size: 1em;
      padding: 7px;
    }
    label {
      font-size: 1.1em;
      font-weight: 600;
      margin-right: 7px;
      vertical-align: middle;
    }
    :root {
      --discord-accent: #5865f2;
      --discord-accent-secondary: #4752c4;
      --discord-success: #57f287;
      --discord-danger: #ed4245;
      --discord-bg-accent: #313338;
      --discord-bg-link: #404eed;
    }
    select, button {
      font-size: 1em;
      padding: 7px 12px;
      border-radius: 5px;
      margin: 0.5em 0.4em 1em 0;
      border: none;
      background: var(--discord-accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: background .14s;
    }
    select:focus, button:focus {
      outline: 2px solid var(--discord-accent-secondary);
    }
    button:disabled {
      background: #292b37;
      color: #aaa;
      cursor: not-allowed;
      opacity: 0.6;
    }
    .output-link {
      display: block;
      margin: 1.5em auto 0 auto;
      width: 98%;
      text-align: center;
      font-size: 1.05em;
      background: var(--discord-bg-link);
      border-radius: 7px;
      padding: 0.95em 0.7em;
      color: #e8ffe9;
      text-decoration: none;
      font-weight: 600;
      border: 2px solid var(--discord-success);
      max-width: 370px;
      transition: background 0.16s;
    }
    .output-link:hover, .output-link:focus {
      background: var(--discord-accent-secondary);
    }
    .note {
      font-size: .95em;
      color: #bbb;
      margin: 0.3em 0 0.6em 0;
      text-align: center;
    }
    .file-list {
      margin: .2em 0 .6em 0;
      font-size: 0.96em;
      color: var(--discord-success);
    }
    .error-message {
      color: var(--discord-danger);
      font-size: .95em;
      margin: .5em 0 0.7em .4em;
    }
    .clear-btn {
      background: var(--discord-danger);
      color: #fff;
      margin-left: 0.3em;
      margin-bottom: 1em;
      border: none;
      border-radius: 5px;
      padding: 7px 13px;
      font-weight: 600;
      cursor: pointer;
      font-size: 1em;
      transition: background .14s;
    }
    .clear-btn:disabled {
      background: #7f2231;
      color: #eee;
      opacity: 0.6;
      cursor: not-allowed;
    }
    .file-priority-table {
      margin-top: 0.4em;
      width: 100%;
      border-collapse: collapse;
      background: #232339;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 1em;
    }
    .file-priority-table th, .file-priority-table td {
      padding: 0.5em 0.7em;
      text-align: left;
      font-size: 0.98em;
    }
    .file-priority-table th {
      background: var(--discord-bg-link);
      color: #f4f9ff;
      font-weight: 700;
      border-bottom: 2px solid var(--discord-accent-secondary);
    }
    .file-priority-table td {
      border-bottom: 1px solid #44465a;
      color: var(--discord-success);
      background: #35365a;
    }
    .file-priority-table input[type="number"] {
      background: #232339;
      color: #fff;
      border: 1px solid var(--discord-accent-secondary);
      border-radius: 3px;
      width: 70px;
      padding: 0.2em 0.35em;
      font-size: 1em;
    }
    .file-priority-table input[type="number"]:focus {
      outline: 2px solid var(--discord-accent-secondary);
      border: 1.5px solid var(--discord-accent-secondary);
    }
    @media (max-width: 500px) {
      .container { padding: .8em 0.4em; }
      .file-priority-table th, .file-priority-table td { font-size: 0.94em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Minecraft KubeJS Script Combiner</h1>
    <label for="scriptType">Script Type:</label>
    <select id="scriptType">
      <option value="server_scripts">server_scripts (Server Scripts)</option>
      <option value="startup_scripts">startup_scripts (Startup Scripts)</option>
      <option value="client_scripts">client_scripts (Client Scripts)</option>
    </select>
    <span class="note">Select script type, then upload one or more .js files</span>
    <input id="fileInput" type="file" multiple accept=".js">
    <button id="clearFilesBtn" type="button" class="clear-btn" disabled>Clear Files</button>
    <div class="file-list" id="fileList"></div>
    <div id="prioritySection"></div>
    <div class="error-message" id="errorMsg"></div>

    <button id="combineBtn" disabled>Combine & Download</button>
    <a style="display:none" class="output-link" id="downloadLink" download="">Download Combined Script</a>
    <span class="note">
      The combined file keeps each script's code, separated by comments indicating original filenames. The order matches your selection or set priority.
    </span>
  </div>
  <script type="module">
    // --- DOM refs
    const fileInput = document.getElementById('fileInput');
    const scriptType = document.getElementById('scriptType');
    const combineBtn = document.getElementById('combineBtn');
    const clearFilesBtn = document.getElementById('clearFilesBtn');
    const fileList = document.getElementById('fileList');
    const errorMsg = document.getElementById('errorMsg');
    const downloadLink = document.getElementById('downloadLink');
    const prioritySection = document.getElementById('prioritySection');

    /**
     * @tweakable If true, allow only JavaScript files for upload (set to ".js")
     */
    const acceptedExtensions = ".js";

    /**
     * @tweakable Also add 'application/javascript' mimetype in file picker accept attribute
     */
    const acceptMimeType = false;

    // Construct accept attribute value for input[type=file]
    function computeAcceptValue() {
      let value = acceptedExtensions;
      if (acceptMimeType) value += ",application/javascript";
      return value;
    }

    // Set accept attribute. Trigger update if @tweakable values changed.
    fileInput.setAttribute("accept", computeAcceptValue());

    // Watch for tweaks: Reflect acceptedExtensions or acceptMimeType changes in file input accept attrib.
    if (window.__tweakableWatchers__ === undefined) window.__tweakableWatchers__ = [];
    window.__tweakableWatchers__.push(() => {
      fileInput.setAttribute("accept", computeAcceptValue());
    });

    /**
     * @tweakable When true, adding more files will append to the list, not replace. 
     */
    let appendFilesOnInput /* @tweakable should adding more files append to the list (true), or replace all (false) */ = true;

    /**
     * @typedef {{
     *   file: File,
     *   priority: number // @tweakable Default script file priority, higher values are placed first in combined file
     * }} PriorityFileWrapper
     */

    /**
     * @tweakable Allow negative priority values for script upload ordering
     */
    const allowNegativePriority = true;

    /**
     * @tweakable The minimum allowed priority value in the input control
     */
    const minPriority = allowNegativePriority ? -1000 : 0;

    /**
     * @tweakable The maximum allowed priority value in the input control
     */
    const maxPriority = 1000;

    // Internal loadedFiles format: Array<{file:File, priority: number}>
    /** @type {PriorityFileWrapper[]} */
    let loadedFiles = [];

    /**
     * Helper to determine if an item is already present by file name & size.
     */
    function alreadyLoaded(file) {
      return loadedFiles.some(lf => lf.file.name === file.name && lf.file.size === file.size);
    }

    fileInput.addEventListener('change', (ev) => {
      const inputFiles = Array.from(ev.target.files);
      // Add as {file, priority}
      if (appendFilesOnInput) {
        for (const f of inputFiles) {
          if (!alreadyLoaded(f)) {
            loadedFiles.push({file: f, priority: 0 /* @tweakable Default file priority when adding new files */});
          }
        }
      } else {
        loadedFiles = inputFiles.map(f => ({file: f, priority: 0 /* @tweakable Default file priority */}));
      }
      listSelectedFiles();
      updatePriorityTable();
      errorMsg.textContent = "";
      combineBtn.disabled = loadedFiles.length === 0;
      clearFilesBtn.disabled = loadedFiles.length === 0;
      downloadLink.style.display = "none";
      // Reset file input so that selecting the same file(s) again triggers 'change'
      fileInput.value = "";
    });

    // Clear files button
    clearFilesBtn.addEventListener('click', () => {
      loadedFiles = [];
      listSelectedFiles();
      updatePriorityTable();
      combineBtn.disabled = true;
      clearFilesBtn.disabled = true;
      errorMsg.textContent = "";
      downloadLink.style.display = "none";
    });

    function listSelectedFiles() {
      if (!loadedFiles.length) {
        fileList.textContent = "";
        clearFilesBtn.disabled = true;
        prioritySection.innerHTML = "";
        return;
      }
      // Only show files matching the acceptedExtensions, warn otherwise
      const extList = acceptedExtensions
        .split(",")
        .map(e => e.trim().toLowerCase().replace(/^\./, ''));
      const goodFiles = loadedFiles.filter(({file}) => {
        const ext = file.name.split('.').pop().toLowerCase();
        return extList.includes(ext);
      });
      const badFiles = loadedFiles.filter(({file}) => !goodFiles.includes(({file}) => file));
      fileList.textContent =
        "Selected files (" + loadedFiles.length + "): " +
        loadedFiles.map(({file})=>file.name).join(", ");

      if (badFiles.length) {
        errorMsg.textContent = "Some files are not accepted: " + badFiles.map(({file})=>file.name).join(", ");
        combineBtn.disabled = true;
      } else if (!goodFiles.length) {
        errorMsg.textContent = "Please select at least one " + acceptedExtensions + " file.";
        combineBtn.disabled = true;
      } else {
        errorMsg.textContent = "";
        combineBtn.disabled = false;
      }
      clearFilesBtn.disabled = loadedFiles.length === 0;
      // Priority table UI handled separately
      updatePriorityTable();
    }

    /**
     * @tweakable Include a comment with the filename between scripts
     */
    const includeFilenameComment = true;

    /**
     * @tweakable Separator string inserted between combined scripts
     */
    const scriptSeparator =
      "\n// ---------------------------------------------------------------------\n";

    // --- File Priority Table ---
    function updatePriorityTable() {
      if (!loadedFiles.length) {
        prioritySection.innerHTML = "";
        return;
      }
      // Sort loadedFiles for display: just as added
      let html = `
      <table class="file-priority-table">
        <thead>
          <tr>
            <th>File Name</th>
            <th>Priority<br>
              <span style="font-weight: 400;font-size:0.88em;color:#ccc;">
                (Higher = Comes earlier)
              </span>
            </th>
          </tr>
        </thead>
        <tbody>
      `;
      for (let i = 0; i < loadedFiles.length; ++i) {
        const f = loadedFiles[i];
        html += `<tr>
          <td>${f.file.name}</td>
          <td>
            <input 
              type="number" 
              min="${minPriority}" 
              max="${maxPriority}" 
              step="1" 
              value="${f.priority}" 
              data-index="${i}" 
              aria-label="Set priority for ${f.file.name}"
              title="Set priority (higher = appears earlier in combined file)">
          </td>
        </tr>`;
      }
      html += `
        </tbody>
      </table>
      <div class="note" style="margin-top:-0.7em;">
        You can adjust the priority of each file. Files with higher priority are placed at the beginning of the combined script.
        <br>Unchanged = priority 0.
      </div>
      `;
      prioritySection.innerHTML = html;
      // Link up input events
      prioritySection.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', e => {
          const idx = parseInt(e.target.dataset.index, 10);
          let v = parseInt(e.target.value, 10);
          if (isNaN(v)) v = 0;
          v = Math.max(minPriority, Math.min(v, maxPriority));
          loadedFiles[idx].priority = v;
        });
      });
    }

    // Combine files logic
    combineBtn.addEventListener('click', async () => {
      errorMsg.textContent = "";
      downloadLink.style.display = "none";
      if (!loadedFiles.length) return;
      // Restrict only to expected file types
      const extList = acceptedExtensions
        .split(",")
        .map(e => e.trim().toLowerCase().replace(/^\./, ''));
      /** @type {PriorityFileWrapper[]} */
      const filesToCombine = loadedFiles.filter(({file}) =>
        extList.includes(file.name.split('.').pop().toLowerCase())
      );
      if (!filesToCombine.length) {
        errorMsg.textContent = "No valid " + acceptedExtensions + " files selected.";
        return;
      }
      // Sort: higher priority first, then original order if same priority
      /** @tweakable Sort order for combined scripts: sort by descending priority, tie-break on original upload order */
      filesToCombine.sort((a, b) => {
        if (b.priority !== a.priority) {
          return b.priority - a.priority; // higher priority first
        }
        // Stable: order as uploaded for ties
        return loadedFiles.indexOf(a) - loadedFiles.indexOf(b);
      });
      try {
        // Read file contents in that order
        const fileContents = await Promise.all(filesToCombine.map(({file, priority}) =>
          file.text().then(content => ({name: file.name, content, priority}))
        ));

        /**
         * @tweakable Format for file priority info comment in the combined file
         * You can edit this template string if you want to change how the priority is rendered.
         * Placeholders: {priority} will be replaced with the value.
         */
        const priorityCommentFormat /* @tweakable combined file 'priority' info comment format */ = "// priority: {priority}";

        const combined = fileContents.map(fc => {
          let c = fc.content.trimEnd();
          let priorityCommentLine = priorityCommentFormat.replace("{priority}", fc.priority);
          if (includeFilenameComment) {
            c = `// --- File: ${fc.name}\n${priorityCommentLine}\n` + c;
          } else {
            c = `${priorityCommentLine}\n` + c;
          }
          return c;
        }).join(scriptSeparator);

        // Pick output file name based on type
        let scriptFolder = scriptType.value;
        let outNameBase;
        switch(scriptFolder) {
          case "server_scripts": outNameBase = "combined_server_script.js"; break;
          case "startup_scripts": outNameBase = "combined_startup_script.js"; break;
          case "client_scripts": outNameBase = "combined_client_script.js"; break;
          default: outNameBase = "combined_script.js";
        }
        const blob = new Blob([combined], {type: 'text/javascript'});
        const url = URL.createObjectURL(blob);
        downloadLink.download = outNameBase;
        downloadLink.href = url;
        downloadLink.style.display = "inline-block";
        downloadLink.textContent = "Download: " + outNameBase;
      } catch(e) {
        errorMsg.textContent = "Error reading files or combining. " + e;
      }
    });

    // Invalidate download if script type changes
    scriptType.addEventListener('change', () => {
      downloadLink.style.display = "none";
    });

    // Enable drag & drop support to append files
    /**
     * @tweakable Enable drag-and-drop for file uploads (true to enable, false to ignore drops)
     */
    let enableDragDrop /* @tweakable enable drag and drop file input */ = true;
    if (enableDragDrop) {
      document.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
      document.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const droppedFiles = Array.from(e.dataTransfer.files).filter(f =>
          f.type === "application/javascript" || f.name.endsWith(".js")
        );
        if (appendFilesOnInput) {
          for (const f of droppedFiles) {
            if (!alreadyLoaded(f)) {
              loadedFiles.push({file: f, priority: 0 /* @tweakable Default file priority for drag drop */});
            }
          }
        } else {
          loadedFiles = droppedFiles.map(f => ({file: f, priority: 0 /* @tweakable Default file priority drag drop */}));
        }
        listSelectedFiles();
        updatePriorityTable();
        errorMsg.textContent = "";
        combineBtn.disabled = loadedFiles.length === 0;
        clearFilesBtn.disabled = loadedFiles.length === 0;
        downloadLink.style.display = "none";
      });
    }
  </script>
</body>
</html>